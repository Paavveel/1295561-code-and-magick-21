(()=>{"use strict";window.GameConstants={Fireball:{size:22,speed:function(e){return e?2:5}||function(e){return e?2:5}},Wizard:{speed:3,width:70,getHeight:function(){return 93.59}||function(e){return 1.377*e},getX:function(e){return(e-70)/2}||function(e){return e/3},getY:function(e){return e/3}||function(e){return e-100}}},window.Game=function(){let e=300,t=700,s=["Кекс","Катя","Игорь"],i={},n="-reversed";i[0]={width:61,height:84,url:"img/wizard.gif"},i[0+n]={width:61,height:84,url:"img/wizard-reversed.gif"},i[1]={width:24,height:24,url:"img/fireball.gif"};let r={0:function(s,i,n){i.keysPressed.UP&&s.y>0&&(s.direction=-9&s.direction,s.direction=4|s.direction,s.y-=s.speed*n*2),i.keysPressed.UP||s.y<e-s.height&&(s.direction=-5&s.direction,s.direction=8|s.direction,s.y+=s.speed*n/3),i.keysPressed.LEFT&&(s.direction=-3&s.direction,s.direction=1|s.direction,s.x-=s.speed*n),i.keysPressed.RIGHT&&(s.direction=-2&s.direction,s.direction=2|s.direction,s.x+=s.speed*n),s.y<0&&(s.y=0),s.y>e-s.height&&(s.y=e-s.height),s.x<0&&(s.x=0),s.x>t-s.width&&(s.x=t-s.width)},1:function(e,s,i){1&e.direction&&(e.x-=e.speed*i),2&e.direction&&(e.x+=e.speed*i),(e.x<0||e.x>t)&&(e.state=1)}},a={CONTINUE:0,WIN:1,FAIL:2,PAUSE:3,INTRO:4},o={0:function(e){return e.garbage.filter((function(e){return 1===e.type})).filter((function(e){return e.x<10&&e.y>240}))[0]?a.WIN:a.CONTINUE}},d={0:function(s){return s.objects.push({direction:2,height:window.GameConstants.Wizard.getHeight(window.GameConstants.Wizard.width),speed:window.GameConstants.Wizard.speed,sprite:i[0],state:0,type:0,width:window.GameConstants.Wizard.width,x:window.GameConstants.Wizard.getX(t),y:window.GameConstants.Wizard.getY(e)}),s}},c=function(e){this.container=e,this.canvas=document.createElement("canvas"),this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._pauseListener=this._pauseListener.bind(this),this.setDeactivated(!1)};c.prototype={level:0,setDeactivated(e){this._deactivated!==e&&(this._deactivated=e,e?this._removeGameListeners():this._initializeGameListeners())},getInitialState:()=>({currentStatus:a.CONTINUE,garbage:[],lastUpdated:null,keysPressed:{ESC:!1,LEFT:!1,RIGHT:!1,SPACE:!1,UP:!1},levelStartTime:null,objects:[],startTime:null}),initializeLevelAndStart(e){(e=void 0===e||e)||!this.state?(this._imagesArePreloaded=void 0,this.state=this.getInitialState(),this.state=d[this.level](this.state)):this.state.currentStatus=a.CONTINUE,this.state.levelStartTime=Date.now(),this.state.startTime||(this.state.startTime=this.state.levelStartTime),this._preloadImagesForLevel(function(){this.render(),this._initializeGameListeners(),this.update()}.bind(this))},pauseLevel(e){e&&(this.state.currentStatus=e),this.state.keysPressed.ESC=!1,this.state.lastUpdated=null,this._removeGameListeners(),window.addEventListener("keydown",this._pauseListener),this._drawPauseScreen()},_pauseListener(e){if(32===e.keyCode&&!this._deactivated){e.preventDefault();let t=this.state.currentStatus===a.WIN||this.state.currentStatus===a.FAIL;this.initializeLevelAndStart(t),window.removeEventListener("keydown",this._pauseListener)}},_drawPauseScreen(){let e;switch(this.state.currentStatus){case a.WIN:if(window.renderStatistics){let e=this._generateStatistics(new Date-this.state.startTime),t=this._shuffleArray(Object.keys(e));return void window.renderStatistics(this.ctx,t,t.map((function(t){return e[t]})))}e="Вы победили Газебо!\nУра!";break;case a.FAIL:e="Вы проиграли!";break;case a.PAUSE:e="Игра на паузе!\nНажмите Пробел, чтобы продолжить";break;case a.INTRO:e="Добро пожаловать!\nНажмите Пробел для начала игры"}this._drawMessage(e)},_generateStatistics(e){let t={Вы:e};for(let i=0;i<s.length;i++){let n=e+(3e3*Math.random()-1500);n<1e3&&(n=1e3),t[s[i]]=n}return t},_shuffleArray(e){for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1)),i=e[t];e[t]=e[s],e[s]=i}return e},_drawMessage(e){let t=this.ctx,s=function(e,s,i,n){t.beginPath(),t.moveTo(e,s),t.lineTo(e+10,s+n/2),t.lineTo(e,s+n),t.lineTo(e+i/2,s+n-10),t.lineTo(e+i,s+n),t.lineTo(e+i-10,s+n/2),t.lineTo(e+i,s),t.lineTo(e+i/2,s+10),t.lineTo(e,s),t.stroke(),t.closePath(),t.fill()};t.fillStyle="rgba(0, 0, 0, 0.7)",s(190,40,320,100),t.fillStyle="rgba(256, 256, 256, 1.0)",s(180,30,320,100),t.fillStyle="#000",t.font="16px PT Mono",e.split("\n").forEach((function(e,s){t.fillText(e,200,80+20*s)}))},_preloadImagesForLevel(e){if(void 0===this._imagesArePreloaded&&(this._imagesArePreloaded=[]),this._imagesArePreloaded[this.level])return void e();let t=Object.keys(i),s=t.length,n=this,r=function(t){let i=new Image(t.width,t.height);i.onload=function(){t.image=i,0==--s&&(n._imagesArePreloaded[n.level]=!0,e())},i.src=t.url};for(let e=0;e<t.length;e++)r(i[t[e]])},updateObjects(e){let t=this.state.objects.filter((function(e){return 0===e.type}))[0];this.state.keysPressed.SHIFT&&(this.state.objects.push({direction:t.direction,height:window.GameConstants.Fireball.size,speed:window.GameConstants.Fireball.speed(!!(1&t.direction)),sprite:i[1],type:1,width:window.GameConstants.Fireball.size,x:2&t.direction?t.x+t.width:t.x-window.GameConstants.Fireball.size,y:t.y+t.height/2}),this.state.keysPressed.SHIFT=!1),this.state.garbage=[];let s=this.state.objects.filter((function(t){return r[t.type](t,this.state,e),1!==t.state||(this.state.garbage.push(t),!1)}),this);this.state.objects=s},checkStatus(){if(this.state.currentStatus!==a.CONTINUE)return;this.commonRules||(this.commonRules=[function(e){return 1===e.objects.filter((function(e){return 0===e.type}))[0].state?a.FAIL:a.CONTINUE},function(e){return e.keysPressed.ESC?a.PAUSE:a.CONTINUE},function(e){return Date.now()-e.startTime>18e4?a.FAIL:a.CONTINUE}]);let e,t=this.commonRules.concat(o[this.level]),s=a.CONTINUE;for(;s===a.CONTINUE&&t.length;)e=t.shift(),s=e(this.state);this.state.currentStatus=s},setGameStatus(e){this.state.currentStatus!==e&&(this.state.currentStatus=e)},render(){this.ctx.clearRect(0,0,t,e),this.state.objects.forEach((function(e){if(e.sprite){let t=1&e.direction,s=i[e.type+(t?n:"")]||i[e.type];this.ctx.drawImage(s.image,e.x,e.y,e.width,e.height)}}),this)},update(){this.state.lastUpdated||(this.state.lastUpdated=Date.now());let e=(Date.now()-this.state.lastUpdated)/10;switch(this.updateObjects(e),this.checkStatus(),this.state.currentStatus){case a.CONTINUE:this.state.lastUpdated=Date.now(),this.render(),requestAnimationFrame(function(){this.update()}.bind(this));break;case a.WIN:case a.FAIL:case a.PAUSE:case a.INTRO:this.pauseLevel()}},_onKeyDown(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!0;break;case 39:this.state.keysPressed.RIGHT=!0;break;case 38:this.state.keysPressed.UP=!0;break;case 27:this.state.keysPressed.ESC=!0}e.shiftKey&&(this.state.keysPressed.SHIFT=!0)},_onKeyUp(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!1;break;case 39:this.state.keysPressed.RIGHT=!1;break;case 38:this.state.keysPressed.UP=!1;break;case 27:this.state.keysPressed.ESC=!1}e.shiftKey&&(this.state.keysPressed.SHIFT=!1)},_initializeGameListeners(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)},_removeGameListeners(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}},c.Verdict=a;let l=new c(document.querySelector(".demo"));return window.restartGame=function(e,t){i[0].url=e,i[0+n].url=t,l.initializeLevelAndStart(),l.setGameStatus(a.INTRO)},window.restartGame("img/wizard.gif","img/wizard-reversed.gif"),l}()})(),(()=>{"use strict";const e=(e,t,s,i)=>{e.fillStyle=i,e.fillRect(t,s,420,270)};window.renderStatistics=(t,s,i)=>{e(t,110,20,"rgba(0, 0, 0, 0.7)"),e(t,100,10,"#fff"),t.fillStyle="#000",t.textBaseline="hanging",t.font="16px PT Mono",t.fillText("Ура вы победили!",120,30),t.fillText("Список результатов:",120,50);const n=(e=>{let t=e[0];for(let s=1;s<e.length;s++)e[s]>t&&(t=e[s]);return t})(i);for(let e=0;e<s.length;e++){const r=Math.round(i[e]);t.fillText(s[e],140+80*e,260);const a=150*i[e]/n;t.save(),"Вы"===s[e]?t.fillStyle="rgba(255, 0, 0, 1)":t.fillStyle=`hsl(237, 100%, ${100,Math.floor(Math.random()*Math.floor(100))}%)`,t.fillRect(140+80*e,250,40,-a),t.restore(),t.fillText(r,140+80*e,230-a)}}})(),(()=>{"use strict";window.data={COAT_COLORS:["rgb(101, 137, 164)","rgb(241, 43, 107)","rgb(146, 100, 161)","rgb(56, 159, 117)","rgb(215, 210, 55)","rgb(0, 0, 0)"],EYES_COLORS:["black","red","blue","yellow","green"],FIREBALL_COLORS:["#ee4830","#30a8ee","#5ce6c0","#e848d5","#e6e848"],WIZARDS_AMOUNT:4,MIN_NAME_LENGTH:2,MAX_NAME_LENGTH:25,coatColor:void 0,eyesColor:void 0}})(),(()=>{"use strict";window.util={isEscEvent:function(e,t){"Escape"===e.key&&t()},isEnterEvent:function(e,t){"Enter"===e.key&&t()},sequenceNumber:function(e,t){let s=e;return()=>(s<t?s++:s=e,s)},createErrorMassage:e=>{const t=document.createElement("div");t.style="z-index: 999; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},debounce:e=>{let t=null;return(...s)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...s)}),500)}}}})(),(()=>{"use strict";window.backend={load:(e,t,s,i,n)=>{const r=new XMLHttpRequest;r.responseType="json",r.timeout=1e4,r.open(e,t),"GET"===e?r.send():"POST"===e&&r.send(n),r.addEventListener("load",(()=>{let e;switch(r.status){case 200:s(r.response);break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено";break;default:e=`Cтатус ответа: : ${r.status} ${r.statusText}`}e&&i(e)})),r.addEventListener("error",(()=>{i("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{i(`Запрос не успел выполниться за ${r.timeout}мс`)}))}}})(),(()=>{"use strict";let e=[];const t=e=>{let t=0;return e.colorCoat===window.data.coatColor&&(t+=2),e.colorEyes===window.data.eyesColor&&(t+=1),t},s=()=>{window.render.render(e.filter(((e,s)=>{let i=t(s)-t(e);return 0===i&&(i=((e,t)=>e>t?1:e<t?-1:0)(e.name,s.name)),i})))},i=e=>{window.util.createErrorMassage(e)};window.backend.load("GET","https://21.javascript.pages.academy/code-and-magick/data",(t=>{e=t,s()}),i);const n=document.querySelector(".setup-wizard-form"),r=()=>{document.querySelector(".setup").classList.add("hidden")};n.addEventListener("submit",(e=>{e.preventDefault(),window.backend.load("POST","https://21.javascript.pages.academy/code-and-magick",r,i,new FormData(n))})),window.script={updateWizards:s}})(),(()=>{"use strict";const e=document.querySelector(".setup"),t=document.querySelector(".setup-open"),s=e.querySelector(".setup-close"),i=e.querySelector(".setup-user-name"),n=()=>{e.classList.remove("hidden")},r=()=>{e.classList.add("hidden")},a=e=>{e.preventDefault(),window.util.isEscEvent(e,r),document.removeEventListener("keydown",a)};t.addEventListener("click",(()=>{n(),document.addEventListener("keydown",a)})),t.addEventListener("keydown",(e=>{window.util.isEnterEvent(e,n),document.addEventListener("keydown",a)})),s.addEventListener("click",(()=>{r(),document.removeEventListener("keydown",a)})),s.addEventListener("keydown",(e=>{window.util.isEnterEvent(e,r),document.removeEventListener("keydown",a)})),i.addEventListener("focus",(()=>{document.removeEventListener("keydown",a)})),i.addEventListener("blur",(()=>{document.addEventListener("keydown",a)})),i.addEventListener("input",(()=>{const e=i.value.length;e<window.data.MIN_NAME_LENGTH?i.setCustomValidity(`Еще ${window.data.MIN_NAME_LENGTH-e} симв.`):e>window.data.MAX_NAME_LENGTH?i.setCustomValidity(`Удалите лишние ${e-window.data.MAX_NAME_LENGTH} симв.`):i.setCustomValidity(""),i.reportValidity()}));const o=e.querySelector(".setup-wizard .wizard-coat"),d=e.querySelector("input[name=coat-color]"),c=e.querySelector(".setup-wizard .wizard-eyes"),l=e.querySelector("input[name=eyes-color]"),u=e.querySelector(".setup-fireball-wrap"),h=e.querySelector("input[name=fireball-color]");function w(e,t,s){const i=window.util.sequenceNumber(0,t.length-1),[n]=t;switch(e){case o:window.data.coatColor=n;break;case c:window.data.eyesColor=n}const r=window.util.debounce(window.script.updateWizards);e.addEventListener("click",(()=>{const n=t[i()];switch("DIV"===e.tagName?e.style.background=n:e.style.fill=n,e){case o:window.data.coatColor=n;break;case c:window.data.eyesColor=n}s.value=n,r()}))}w(u,window.data.FIREBALL_COLORS,h),w(o,window.data.COAT_COLORS,d),w(c,window.data.EYES_COLORS,l);const m=e.querySelector(".upload");m.addEventListener("mousedown",(t=>{t.preventDefault();let s={x:t.clientX,y:t.clientY},i=!1;const n=t=>{t.preventDefault(),i=!0;const n=s.x-t.clientX,r=s.y-t.clientY;s={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-r+"px",e.style.left=e.offsetLeft-n+"px"},r=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r),i){const e=t=>{t.preventDefault(),m.removeEventListener("click",e)};m.addEventListener("click",e)}};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)}))})(),(()=>{"use strict";const e=document.querySelector("#similar-wizard-template").content.querySelector(".setup-similar-item"),t=t=>{const s=e.cloneNode(!0);return s.querySelector(".setup-similar-label").textContent=t.name,s.querySelector(".wizard-coat").style.fill=t.colorCoat,s.querySelector(".wizard-eyes").style.fill=t.colorEyes,s},s=document.querySelector(".setup-similar"),i=document.querySelector(".setup-similar-list");window.render={render:e=>{const n=document.createDocumentFragment(),r=e.length>window.data.WIZARDS_AMOUNT?window.data.WIZARDS_AMOUNT:e.length;for(let s=0;s<r;s++)n.append(t(e[s]));i.innerHTML="",i.append(n),s.classList.remove("hidden")}}})();